<script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // åŸºç¤ç‹€æ…‹
            const appTitle = ref('æˆ‘çš„æ—…éŠ App') 
            const currentTab = ref('Schedule') 
            
            // --- å­—é«”é¸æ“‡ç‹€æ…‹ ---
            const fontOptions = ref([
                { id: 'sans-serif', name: 'ç³»çµ±é è¨­å­—é«”' },
                { id: 'ChenYuluoyan', name: 'é™³æ‚…è½é›é«” (Thin)' }, 
                { id: 'NanumPenScript', name: 'NanumPenScript (æ‰‹å¯«é«”)' } 
            ]);
            const selectedFont = ref('ChenYuluoyan'); 
            
            // --- æ—…éŠæ—¥æœŸè¨­å®š ---
            const tripStartDate = ref('2025-12-08'); 
            const totalTripDays = ref(4);
            const currentDay = ref(tripStartDate.value); 

            // --- è²¨å¹£å’ŒåŒ¯ç‡ç‹€æ…‹ ---
            const baseCurrency = ref('TWD') 
            const exchangeRates = ref({})  
            const exchangeRate = ref(0.21) 
            // API ç«¯é»ç¾åœ¨å°‡æ ¹æ“š baseCurrency å‹•æ…‹æ›¿æ›
            const apiEndpoint = `https://api.exchangerate-api.com/v4/latest/${baseCurrency.value}`; 

            // --- å¤©æ°£ç‹€æ…‹ ---
            const weatherLocation = ref('Taipei'); // é è¨­åŸå¸‚æ”¹ç‚ºå°åŒ—
            const weather = ref({
                temp: 28,
                description: 'å¤šé›²ï¼Œå¶é™£é›¨',
                icon: 'ğŸŒ§ï¸',
                date: '12æœˆ12æ—¥',
                loading: false
            });

            // --- èˆªç­è³‡è¨Šç‹€æ…‹ (æ–°å¢èˆªå»ˆ/ç™»æ©Ÿé–€) ---
            const flightInfo = ref({
                number: 'CI100', 
                status: 'æº–æ™‚', 
                departureTime: '09:05',
                departureAirport: 'TPE',
                arrivalTime: '13:00',
                arrivalAirport: 'NRT',
                checkInTime: '07:00',
                terminal: 'T2',      // æ–°å¢ï¼šèˆªå»ˆ
                gate: 'B10'          // æ–°å¢ï¼šç™»æ©Ÿé–€
            });

            // --- æ¨¡æ…‹æ¡†ç‹€æ…‹ ---
            const showAccountingModal = ref(false)
            const showTodoModal = ref(false) 
            const showShoppingModal = ref(false) 
            const showScheduleModal = ref(false) 
            const showEditModal = ref(false)
            const editingItem = ref({ type: '', typeLabel: '', data: null }); 
            
            // --- æ–°å¢é …ç›®è¡¨å–®ç‹€æ…‹ ---
            const newExpense = ref({
                amount: null, name: '', type: 'cash', currency: 'JPY', date: '2025-12-08' 
            })
            const newTodo = ref({ 
                name: ''
            })
            const newShoppingItem = ref({ 
                name: '',
                price: null
            })
            const newScheduleItem = ref({ 
                 time: '',
                 name: ''
            })
            
            // ä¸»é¡Œé¡è‰²ç‹€æ…‹
            const primaryColorInput = ref('#3b82f6')
            const primaryColor = ref('#3b82f6')
            const appBgColor = ref('#c3e0ff')
            
            // æ•¸æ“šæ¸…å–®
            const expenses = ref([
                { id: 101, name: 'åˆé¤ï¼šæ‹‰éºµ', amount: 1500, currency: 'JPY', type: 'cash', date: '2025-12-08' },
                { id: 104, name: 'ä¿éšª', amount: 1000, currency: 'TWD', type: 'credit', date: 'PreTrip' },
            ])
            const expenseFilter = ref('all') 
            
            const todoList = ref([
                { id: 1, name: 'è³¼è²·æ—…éŠä¿éšª', completed: false },
                { id: 2, name: 'è²·ç¶²å¡/SIMå¡', completed: true },
            ])
            
            const shoppingList = ref([
                { id: 201, name: 'CEZANNE 101è™Ÿå”‡è†', price: 3000, imgUrl: 'https://via.placeholder.com/150/f9fafb/555555?text=Lipstick', purchased: false },
            ])
            
            const scheduleList = ref([
                { id: 1, name: 'é£›æ©ŸæŠµé” NRT', time: '13:00', date: '2025-12-08' },
                { id: 2, name: 'é£¯åº— Check-in', time: '15:00', date: '2025-12-08' },
                { id: 3, name: 'æ™šé¤ï¼šå£½å¸å¤§', time: '18:30', date: '2025-12-08' },
            ])


            // --- Computed å±¬æ€§ ---
            
            const days = computed(() => {
                const dayList = [{ label: 'è¡Œå‰', date: 'PreTrip', dayOfMonth: '' }]; 
                const startDate = new Date(tripStartDate.value);
                
                for (let i = 0; i < totalTripDays.value; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const isoDate = date.toISOString().split('T')[0]; 
                    const dayOfMonth = date.getDate().toString().padStart(2, '0'); 
                    
                    dayList.push({ label: `Day ${i + 1}`, date: isoDate, dayOfMonth: dayOfMonth });
                }
                
                if (!dayList.find(d => d.date === currentDay.value) && totalTripDays.value > 0) {
                     currentDay.value = dayList[1].date; 
                }
                return dayList;
            })
            
            const currentDayLabel = computed(() => {
                return days.value.find(d => d.date === currentDay.value)?.label || 'ç•¶å‰';
            })
            
            const baseCurrencySymbol = computed(() => getCurrencySymbol(baseCurrency.value));

            const convertToBaseCurrency = (amount, currency) => {
                if (currency === baseCurrency.value) { return amount; }
                const rateToBase = exchangeRates.value[baseCurrency.value]; // åœ¨æ–°çš„ API è¨­è¨ˆä¸­ï¼ŒrateToBase æ‡‰ç‚º 1 (å¦‚æœ API ä»¥ baseCurrency ç‚ºåŸºæº–)
                const rateFrom = exchangeRates.value[currency];

                if (exchangeRates.value[baseCurrency.value] === 1) { 
                    // å¦‚æœ API ä»¥ baseCurrency ç‚ºåŸºæº–ï¼Œå‰‡ç›´æ¥ç”¨ 1/rateFrom
                    return amount / rateFrom;
                }
                
                // Fallback é‚è¼¯
                if (currency === 'JPY' && baseCurrency.value === 'TWD') { return amount * 0.21; }
                return amount; 
            }

            const totalExpense = computed(() => {
                return expenses.value
                    .filter(e => e.date !== 'PreTrip')
                    .reduce((sum, e) => sum + convertToBaseCurrency(Math.abs(e.amount), e.currency), 0)
                    .toFixed(0);
            })

            const filteredExpenses = computed(() => {
                 return expenses.value.filter(e => {
                    const dateMatch = (currentDay.value === 'PreTrip' && e.date === 'PreTrip') || 
                                     (currentDay.value !== 'PreTrip' && e.date === currentDay.value);
                                     
                    if (expenseFilter.value === 'all') return dateMatch;
                    return dateMatch && e.type === expenseFilter.value;
                });
            })
            
            const filteredSchedule = computed(() => {
                return scheduleList.value
                    .filter(item => item.date === currentDay.value)
                    .sort((a, b) => a.time.localeCompare(b.time)); 
            })


            // --- Methods ---

            // ç²å–å¯¦æ™‚åŒ¯ç‡ (ä¿®æ”¹ï¼šä»¥ baseCurrency ç‚ºåŸºæº–)
            const fetchExchangeRate = async () => {
                const dynamicApiEndpoint = `https://api.exchangerate-api.com/v4/latest/${baseCurrency.value}`;
                exchangeRate.value = null; 

                try {
                    const response = await fetch(dynamicApiEndpoint);
                    if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥åŒ¯ç‡æ•¸æ“š');
                    
                    const data = await response.json();
                    
                    if (data && data.rates) {
                        exchangeRates.value = data.rates;
                        // é¡¯ç¤º JPY å…Œæ› baseCurrency çš„åŒ¯ç‡ (å› ç‚ºå¸¸å¸¸ç”¨åˆ°æ—¥å¹£)
                        exchangeRate.value = data.rates['JPY']; 
                    } else {
                         throw new Error('åŒ¯ç‡æ•¸æ“šæ ¼å¼éŒ¯èª¤');
                    }
                } catch (error) {
                    console.error('ç²å–åŒ¯ç‡å¤±æ•—:', error);
                    // æ“´å……é è¨­åŒ¯ç‡ (ä»¥ TWD ç‚ºåŸºæº–çš„æ¨¡æ“¬åŒ¯ç‡)
                    exchangeRates.value = { 
                        "TWD": 1, "USD": 0.032, "JPY": 4.75, "CNY": 0.23, "EUR": 0.029, 
                        "KRW": 43.5, "GBP": 0.025 
                    }; 
                    // å¦‚æœ baseCurrency æ˜¯ TWDï¼Œå‰‡é¡¯ç¤º JPY å…Œæ› TWD çš„åŒ¯ç‡ (4.75 JPY = 1 TWD)
                    exchangeRate.value = exchangeRates.value['JPY'] || 4.75; 
                }
            }
            
            // ç²å–å¤©æ°£è³‡è¨Š (æ“´å……æ¨¡æ“¬åŸå¸‚)
            const fetchWeather = async (location = weatherLocation.value) => {
                weather.value = { 
                    temp: null, 
                    description: 'è¼‰å…¥ä¸­...', 
                    icon: 'â³', 
                    date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }),
                    loading: true
                };
                
                await new Promise(resolve => setTimeout(resolve, 800)); 
                
                const lowerLocation = location.toLowerCase();

                if (lowerLocation.includes('taipei') || lowerLocation.includes('å°åŒ—')) {
                     weather.value = { temp: 28, description: 'å¤šé›²ï¼Œå¶é™£é›¨', icon: 'ğŸŒ§ï¸', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }), loading: false };
                } else if (lowerLocation.includes('tokyo') || lowerLocation.includes('æ±äº¬')) {
                     weather.value = { temp: 20, description: 'æ™´æœ—ï¼Œå¾®é¢¨', icon: 'â˜€ï¸', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }), loading: false };
                } else if (lowerLocation.includes('seoul') || lowerLocation.includes('é¦–çˆ¾')) {
                     weather.value = { temp: 15, description: 'æ™´æœ—ï¼Œä¹¾ç‡¥', icon: 'ğŸ”†', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }), loading: false };
                } else if (lowerLocation.includes('bangkok') || lowerLocation.includes('æ›¼è°·')) {
                     weather.value = { temp: 33, description: 'ç‚ç†±ï¼Œæœ‰é›·é™£é›¨', icon: 'â›ˆï¸', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }), loading: false };
                } else if (lowerLocation.includes('london') || lowerLocation.includes('å€«æ•¦') || lowerLocation.includes('gbp')) {
                     weather.value = { temp: 12, description: 'é™°å¤©ï¼Œéœ§æ¿›æ¿›', icon: 'ğŸŒ«ï¸', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }), loading: false };
                } else if (lowerLocation.includes('paris') || lowerLocation.includes('å·´é»')) {
                     weather.value = { temp: 18, description: 'æ™´ç©ºè¬é‡Œ', icon: 'ğŸŒ', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }), loading: false };
                } else {
                     weather.value = { temp: null, description: `æœªæ‰¾åˆ° ${location} çš„æ¨¡æ“¬æ•¸æ“š`, icon: 'âŒ', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }), loading: false };
                }
                weatherLocation.value = location; 
            }
            
            // å¯¦æ™‚èˆªç­è¿½è¹¤åŠŸèƒ½ (æ¨¡æ“¬)
            const fetchFlightStatus = async () => {
                if (!flightInfo.value.number) return; 
                await new Promise(resolve => setTimeout(resolve, 1000)); 

                console.log(`æ­£åœ¨æ¨¡æ“¬è¿½è¹¤èˆªç­ ${flightInfo.value.number} çš„å¯¦æ™‚ç‹€æ…‹...`);
                
                const currentStatus = ['æº–æ™‚', 'å»¶é² 15 åˆ†é˜', 'å·²ç™»æ©Ÿ', 'å·²æŠµé”', 'å–æ¶ˆ'];
                const randomStatus = currentStatus[Math.floor(Math.random() * currentStatus.length)];
                
                flightInfo.value.status = randomStatus; 
                // æ¨¡æ“¬ç™»æ©Ÿé–€æˆ–èˆªå»ˆè®Šæ›´
                if (randomStatus === 'å»¶é² 15 åˆ†é˜') {
                     flightInfo.value.gate = 'C05';
                     flightInfo.value.terminal = 'T1';
                }
            }


            const getCurrencySymbol = (currency) => {
                switch(currency) {
                    case 'TWD': return '$';
                    case 'USD': return '$';
                    case 'JPY': return 'Â¥';
                    case 'CNY': return 'Â¥';
                    case 'EUR': return 'â‚¬';
                    case 'KRW': return 'â‚©'; // æ–°å¢éŸ“å…ƒç¬¦è™Ÿ
                    case 'GBP': return 'Â£'; // æ–°å¢è‹±éŠç¬¦è™Ÿ
                    default: return '';
                }
            }

            const updateTheme = (hex) => {
                primaryColor.value = hex;
                document.documentElement.style.setProperty('--primary-color', hex);
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                
                if (g > r && g > b) { appBgColor.value = '#d1fae5'; } 
                else if (r > b) { appBgColor.value = '#fbe2e2'; } 
                else { appBgColor.value = '#c3e0ff'; }
            }
            
            const addExpense = () => {
                if (!newExpense.value.amount || !newExpense.value.name) return;

                const expense = { ...newExpense.value, id: Date.now(), amount: Math.abs(newExpense.value.amount) };
                expenses.value.push(expense);
                
                newExpense.value = { amount: null, name: '', type: 'cash', currency: 'JPY', date: currentDay.value || days.value[1].date };
                showAccountingModal.value = false;
                if (currentTab.value !== 'Accounting') { currentTab.value = 'Accounting'; }
            }
            
            const addTodoItem = () => {
                if (!newTodo.value.name) return;
                
                const item = {
                    id: Date.now(),
                    name: newTodo.value.name,
                    completed: false
                };
                
                todoList.value.push(item);
                newTodo.value.name = ''; 
                showTodoModal.value = false;
            }

            const addShoppingItem = () => {
                if (!newShoppingItem.value.name || !newShoppingItem.value.price) return;
                
                const item = {
                    id: Date.now(),
                    name: newShoppingItem.value.name,
                    price: newShoppingItem.value.price,
                    imgUrl: 'https://via.placeholder.com/150/f9fafb/555555?text=Shopping', 
                    purchased: false
                };
                
                shoppingList.value.push(item);
                newShoppingItem.value = { name: '', price: null }; 
                showShoppingModal.value = false;
            }
            
            const addScheduleItem = () => {
                if (!newScheduleItem.value.name) return;
                
                const item = {
                    id: Date.now(),
                    name: newScheduleItem.value.name,
                    time: newScheduleItem.value.time,
                    date: currentDay.value
                };
                
                scheduleList.value.push(item);
                newScheduleItem.value = { name: '', time: '' }; 
                showScheduleModal.value = false;
            }


            const openEditModal = (type, itemData) => {
                let label = '';
                if (type === 'Todo') label = 'ä»£è¾¦äº‹é …';
                else if (type === 'Shopping') label = 'è³¼ç‰©æ¸…å–®é …ç›®';
                else if (type === 'Schedule') label = 'è¡Œç¨‹é …ç›®';
                else if (type === 'Accounting') label = 'æ”¯å‡ºç´€éŒ„';
                else if (type === 'Flight') label = 'èˆªç­è³‡è¨Š';

                editingItem.value = { type: type, typeLabel: label, data: JSON.parse(JSON.stringify(itemData)) };
                showEditModal.value = true;
            }

            const saveEdit = () => {
                const item = editingItem.value;
                const itemId = item.data.id;

                if (item.type === 'Todo') {
                    const index = todoList.value.findIndex(i => i.id === itemId);
                    if (index !== -1) todoList.value[index] = item.data;
                } else if (item.type === 'Shopping') {
                    const index = shoppingList.value.findIndex(i => i.id === itemId);
                    if (index !== -1) shoppingList.value[index] = item.data;
                } else if (item.type === 'Accounting') {
                    const index = expenses.value.findIndex(i => i.id === itemId);
                    if (index !== -1) expenses.value[index] = item.data;
                } else if (item.type === 'Schedule') { 
                     const index = scheduleList.value.findIndex(i => i.id === itemId);
                    if (index !== -1) scheduleList.value[index] = item.data;
                } else if (item.type === 'Flight') {
                    flightInfo.value = item.data; 
                    fetchFlightStatus(); 
                }
                
                showEditModal.value = false;
            }

            const deleteItem = (listName, id) => {
                if (listName === 'Todo') {
                    todoList.value = todoList.value.filter(item => item.id !== id);
                } else if (listName === 'Shopping') {
                    shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                } else if (listName === 'Accounting') {
                     expenses.value = expenses.value.filter(item => item.id !== id);
                } else if (listName === 'Schedule') { 
                    scheduleList.value = scheduleList.value.filter(item => item.id !== id);
                }
            }
            
            const deleteAndCloseEditModal = (type, id) => {
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ${editingItem.value.typeLabel} å—ï¼Ÿ`)) {
                    deleteItem(type, id);
                    showEditModal.value = false;
                }
            }
            
            const openModal = (tab) => {
                if (tab === 'Schedule') showScheduleModal.value = true;
                else if (tab === 'PreTrip') showTodoModal.value = true;
                else if (tab === 'Accounting') showAccountingModal.value = true;
                else if (tab === 'Shopping') showShoppingModal.value = true;
            }
            
            onMounted(() => {
                document.documentElement.style.setProperty('--primary-color', primaryColorInput.value);
                fetchExchangeRate(); 
                fetchWeather('Taipei'); // é¦–æ¬¡è¼‰å…¥æ¨¡æ“¬ IP å®šä½åˆ°å°åŒ—
                fetchFlightStatus(); 

                setInterval(() => {
                    fetchExchangeRate();
                    fetchFlightStatus();
                }, 300000); 
                
                if (currentTab.value === 'Accounting' && days.value.length > 1) {
                    newExpense.value.date = currentDay.value;
                }
            });

            return {
                appTitle, currentTab, tripStartDate, totalTripDays, 
                days, currentDay, currentDayLabel,
                primaryColor, primaryColorInput, appBgColor, updateTheme,
                fontOptions, selectedFont, 
                // è²¨å¹£èˆ‡åŒ¯ç‡ (æ›´æ–°)
                baseCurrency, exchangeRate, baseCurrencySymbol, getCurrencySymbol, fetchExchangeRate, convertToBaseCurrency,
                // å¤©æ°£ (æ›´æ–°)
                weatherLocation, weather, fetchWeather, 
                // èˆªç­ (æ›´æ–°)
                flightInfo, fetchFlightStatus, 
                // è¨˜å¸³åŠŸèƒ½ç›¸é—œ
                expenses, expenseFilter, filteredExpenses, totalExpense,
                showAccountingModal, newExpense, addExpense,
                // æ¸…å–®åŠè¡Œç¨‹
                todoList, addTodoItem, newTodo, showTodoModal,
                shoppingList, addShoppingItem, newShoppingItem, showShoppingModal,
                scheduleList, filteredSchedule, addScheduleItem, newScheduleItem, showScheduleModal,
                // ç·¨è¼¯åŠŸèƒ½ç›¸é—œ
                showEditModal, editingItem, openEditModal, saveEdit, deleteAndCloseEditModal,
                // é€šç”¨
                openModal, deleteItem,
            }
        }
    }).mount('#app')
</script>
