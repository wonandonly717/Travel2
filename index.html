<script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // åŸºç¤ç‹€æ…‹
            const appTitle = ref('æˆ‘çš„æ—¥æœ¬ä¹‹æ—…')
            const currentTab = ref('Schedule') 
            
            // --- æ—…éŠæ—¥æœŸè¨­å®š (æ–°å¢) ---
            const tripStartDate = ref('2025-12-08'); 
            const totalTripDays = ref(4);

            // --- è²¨å¹£å’ŒåŒ¯ç‡ç‹€æ…‹ ---
            const baseCurrency = ref('TWD') 
            const exchangeRates = ref({})  
            const exchangeRate = ref(0.21) 
            const apiEndpoint = 'https://api.exchangerate-api.com/v4/latest/JPY'; 

            // --- å¤©æ°£ç‹€æ…‹ ---
            const weatherLocation = ref('Tokyo'); 
            const weather = ref({
                temp: 20,
                description: 'æ™´æœ—ï¼Œå¾®é¢¨',
                icon: 'â˜€ï¸',
                date: '12æœˆ12æ—¥'
            });

            // --- èˆªç­è³‡è¨Šç‹€æ…‹ ---
            const flightInfo = ref({
                number: 'CI100',
                departureTime: '09:05',
                departureAirport: 'TPE',
                arrivalTime: '13:00',
                arrivalAirport: 'NRT',
                checkInTime: '07:00'
            });


            // --- è¨˜å¸³æ¨¡æ…‹æ¡†ç‹€æ…‹ ---
            const showAccountingModal = ref(false)
            const showEditModal = ref(false)
            const editingItem = ref({ type: '', typeLabel: '', data: null }); 
            const newExpense = ref({
                amount: null,
                name: '',
                type: 'cash',
                currency: 'JPY', 
                date: '2025-12-08' // ä½¿ç”¨ ISO æ—¥æœŸæ ¼å¼ä½œç‚º ID
            })
            
            // ä¸»é¡Œé¡è‰²ç‹€æ…‹
            const primaryColorInput = ref('#3b82f6')
            const primaryColor = ref('#3b82f6')
            const appBgColor = ref('#c3e0ff')
            
            // è¨˜å¸³æ•¸æ“š (èª¿æ•´ç‚ºä½¿ç”¨ ISO æ—¥æœŸæ ¼å¼ä½œç‚º 'date')
            const expenses = ref([
                { id: 101, name: 'åˆé¤ï¼šæ‹‰éºµ', amount: 1500, currency: 'JPY', type: 'cash', date: '2025-12-08' },
                { id: 102, name: 'åœ°éµç¥¨', amount: 400, currency: 'JPY', type: 'credit', date: '2025-12-08' },
                { id: 103, name: 'ä¼´æ‰‹ç¦®', amount: 500, currency: 'USD', type: 'credit', date: '2025-12-09' },
                { id: 104, name: 'ä¿éšª', amount: 1000, currency: 'TWD', type: 'credit', date: 'PreTrip' },
            ])
            const expenseFilter = ref('all') 
            
            // ä»£è¾¦æ¸…å–® (Todo List)
            const todoList = ref([
                { id: 1, name: 'è³¼è²·æ—…éŠä¿éšª', completed: false },
                { id: 2, name: 'è²·ç¶²å¡/SIMå¡', completed: true },
                { id: 3, name: 'å…Œæ›æ—¥å¹£ç¾é‡‘', completed: false },
            ])
            // è³¼ç‰©æ¸…å–®æ•¸æ“š
            const shoppingList = ref([
                { id: 201, name: 'CEZANNE 101è™Ÿå”‡è†', price: 3000, imgUrl: 'https://via.placeholder.com/150/f9fafb/555555?text=Lipstick', purchased: false },
            ])

            // ç¢ºä¿ currentDay åˆå§‹å€¼èˆ‡ tripStartDate åŒæ­¥ï¼Œé¿å…ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ç‚ºèˆŠçš„æ—¥æœŸ
            const currentDay = ref(tripStartDate.value);

            // --- Computed å±¬æ€§ ---
            
            // å‹•æ…‹ç”Ÿæˆè¡Œç¨‹å¤©æ•¸ Tab
            const days = computed(() => {
                const dayList = [{ label: 'è¡Œå‰', date: 'PreTrip', dayOfMonth: '' }]; 
                const startDate = new Date(tripStartDate.value);
                
                for (let i = 0; i < totalTripDays.value; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const isoDate = date.toISOString().split('T')[0]; // YYYY-MM-DD
                    const dayOfMonth = date.getDate().toString().padStart(2, '0'); // æ—¥
                    
                    dayList.push({
                        label: `Day ${i + 1}`,
                        date: isoDate,
                        dayOfMonth: dayOfMonth 
                    });
                }
                
                // æª¢æŸ¥ currentDay æ˜¯å¦æœ‰æ•ˆ (é€™æ¬¡ä¿®æ”¹ç§»é™¤äº†å¯èƒ½æœƒé€ æˆå¾ªç’°ä¾è³´çš„å¤–éƒ¨è¨­ç½®)
                if (!dayList.find(d => d.date === currentDay.value) && totalTripDays.value > 0) {
                     currentDay.value = dayList[1].date; // é è¨­è·³åˆ° Day 1
                }
                
                return dayList;
            })
            
            const currentDayLabel = computed(() => {
                return days.value.find(d => d.date === currentDay.value)?.label || 'ç•¶å‰';
            })
            
            const baseCurrencySymbol = computed(() => getCurrencySymbol(baseCurrency.value));

            // åŒ¯ç‡è½‰æ›é‚è¼¯
            const convertToBaseCurrency = (amount, currency) => {
                if (currency === baseCurrency.value) {
                    return amount;
                }
                const rateToBase = exchangeRates.value[baseCurrency.value];
                const rateFrom = exchangeRates.value[currency];

                if (rateFrom && rateToBase) {
                    return amount * (rateToBase / rateFrom);
                }
                
                // é è¨­åŒ¯ç‡ (ä½œç‚º fallback)
                if (currency === 'JPY' && baseCurrency.value === 'TWD') {
                     return amount * 0.21;
                }
                if (currency === 'TWD' && baseCurrency.value === 'JPY') {
                     return amount / 0.21;
                }

                return amount; 
            }

            // ç¸½æ”¯å‡º (ç•¥)
            const totalExpense = computed(() => {
                return expenses.value
                    .filter(e => e.date !== 'PreTrip')
                    .reduce((sum, e) => sum + convertToBaseCurrency(Math.abs(e.amount), e.currency), 0)
                    .toFixed(0);
            })

            const filteredExpenses = computed(() => {
                 return expenses.value.filter(e => {
                    const dateMatch = (currentDay.value === 'PreTrip' && e.date === 'PreTrip') || 
                                     (currentDay.value !== 'PreTrip' && e.date === currentDay.value);
                                     
                    if (expenseFilter.value === 'all') return dateMatch;
                    return dateMatch && e.type === expenseFilter.value;
                });
            })

            // --- Methods ---

            // ç²å–å¯¦æ™‚åŒ¯ç‡ (ç•¥)
            const fetchExchangeRate = async () => {
                exchangeRate.value = null; 

                try {
                    const response = await fetch(apiEndpoint);
                    if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥åŒ¯ç‡æ•¸æ“š');
                    
                    const data = await response.json();
                    
                    if (data && data.rates) {
                        exchangeRates.value = data.rates;
                        exchangeRate.value = data.rates[baseCurrency.value];
                    } else {
                         throw new Error('åŒ¯ç‡æ•¸æ“šæ ¼å¼éŒ¯èª¤');
                    }
                } catch (error) {
                    console.error('ç²å–åŒ¯ç‡å¤±æ•—:', error);
                    exchangeRates.value = {
                        "TWD": 0.21, "USD": 0.0067, "JPY": 1, "CNY": 0.048, "EUR": 0.0061
                    };
                    exchangeRate.value = exchangeRates.value[baseCurrency.value] || 0.21;
                }
            }
            
            // ç²å–å¤©æ°£è³‡è¨Š (ç•¥)
            const fetchWeather = async () => {
                const location = weatherLocation.value;
                weather.value = { temp: null, description: 'è¼‰å…¥ä¸­...', icon: 'â³', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }) };
                await new Promise(resolve => setTimeout(resolve, 500)); 

                if (location === 'Tokyo') {
                     weather.value = { temp: 20, description: 'æ™´æœ—ï¼Œå¾®é¢¨', icon: 'â˜€ï¸', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }) };
                } else if (location === 'Taipei') {
                     weather.value = { temp: 28, description: 'å¤šé›²ï¼Œå¶é™£é›¨', icon: 'ğŸŒ§ï¸', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }) };
                } else if (location === 'Osaka') {
                     weather.value = { temp: 22, description: 'é™°å¤©ï¼Œæ¶¼çˆ½', icon: 'â˜ï¸', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }) };
                } else {
                     weather.value = { temp: null, description: 'åœ°å€æ•¸æ“šç¼ºå¤±', icon: 'âŒ', date: new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' }) };
                }
            }


            // ç²å–è²¨å¹£ç¬¦è™Ÿ (ç•¥)
            const getCurrencySymbol = (currency) => {
                switch(currency) {
                    case 'TWD': return '$';
                    case 'USD': return '$';
                    case 'JPY': return 'Â¥';
                    case 'CNY': return 'Â¥';
                    case 'EUR': return 'â‚¬';
                    default: return '';
                }
            }

            // ä¸»é¡Œè‰²æ›´æ–° (ç•¥)
            const updateTheme = (hex) => {
                primaryColor.value = hex;
                document.documentElement.style.setProperty('--primary-color', hex);
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                
                if (g > r && g > b) {
                     appBgColor.value = '#d1fae5';
                } else if (r > b) {
                    appBgColor.value = '#fbe2e2'; 
                } else {
                    appBgColor.value = '#c3e0ff'; 
                }
            }
            
            // æ–°å¢æ”¯å‡º (ç•¥)
            const addExpense = () => {
                if (!newExpense.value.amount || !newExpense.value.name) return;

                const expense = {
                    ...newExpense.value,
                    id: Date.now(),
                    amount: Math.abs(newExpense.value.amount),
                };
                
                expenses.value.push(expense);
                
                // é‡è¨­è¡¨å–®
                newExpense.value = { amount: null, name: '', type: 'cash', currency: 'JPY', date: currentDay.value || days.value[1].date };
                showAccountingModal.value = false;

                if (currentTab.value !== 'Accounting') {
                    currentTab.value = 'Accounting';
                }
            }

            // æ‰“é–‹ç·¨è¼¯æ¨¡æ…‹æ¡† (ç•¥)
            const openEditModal = (type, itemData) => {
                let label = '';
                if (type === 'Todo') label = 'ä»£è¾¦äº‹é …';
                else if (type === 'Shopping') label = 'è³¼ç‰©æ¸…å–®é …ç›®';
                else if (type === 'Schedule') label = 'è¡Œç¨‹é …ç›®';
                else if (type === 'Accounting') label = 'æ”¯å‡ºç´€éŒ„';
                else if (type === 'Flight') label = 'èˆªç­è³‡è¨Š';

                editingItem.value = {
                    type: type,
                    typeLabel: label,
                    data: JSON.parse(JSON.stringify(itemData)) 
                };
                showEditModal.value = true;
            }

            // å„²å­˜ç·¨è¼¯å¾Œçš„é …ç›® (ç•¥)
            const saveEdit = () => {
                const item = editingItem.value;
                const itemId = item.data.id;

                if (item.type === 'Todo') {
                    const index = todoList.value.findIndex(i => i.id === itemId);
                    if (index !== -1) todoList.value[index] = item.data;
                } else if (item.type === 'Shopping') {
                    const index = shoppingList.value.findIndex(i => i.id === itemId);
                    if (index !== -1) shoppingList.value[index] = item.data;
                } else if (item.type === 'Accounting') {
                    const index = expenses.value.findIndex(i => i.id === itemId);
                    if (index !== -1) expenses.value[index] = item.data;
                } else if (item.type === 'Flight') {
                    flightInfo.value = item.data; 
                }
                
                showEditModal.value = false;
            }

            // åˆªé™¤é …ç›® (ç•¥)
            const deleteItem = (listName, id) => {
                if (listName === 'Todo') {
                    todoList.value = todoList.value.filter(item => item.id !== id);
                } else if (listName === 'Shopping') {
                    shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                } else if (listName === 'Accounting') {
                     expenses.value = expenses.value.filter(item => item.id !== id);
                }
            }
            
            const deleteAndCloseEditModal = (type, id) => {
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ${editingItem.value.typeLabel} å—ï¼Ÿ`)) {
                    deleteItem(type, id);
                    showEditModal.value = false;
                }
            }
            
            const openModal = (tab) => {
                alert(`æ¨¡æ“¬ï¼šé–‹å•Ÿ ${tab} çš„æ–°å¢è¡¨å–®ï¼Œè«‹ä½¿ç”¨ç·¨è¼¯åŠŸèƒ½ä¿®æ”¹ç¯„ä¾‹é …ç›®ã€‚`);
            }
            
            onMounted(() => {
                document.documentElement.style.setProperty('--primary-color', primaryColorInput.value);
                // è¼‰å…¥æ™‚ç²å–åŒ¯ç‡å’Œå¤©æ°£
                fetchExchangeRate(); 
                fetchWeather();
                
                // ã€ä¿®å¾©ã€‘åŸæœ¬æœ‰å•é¡Œçš„ç¨‹å¼ç¢¼ç§»åˆ°é€™è£¡ï¼Œç¢ºä¿ Vue å·²åˆå§‹åŒ–
                if (currentTab.value === 'Accounting' && days.value.length > 1) {
                    newExpense.value.date = currentDay.value;
                }
            });

            return {
                appTitle, currentTab, tripStartDate, totalTripDays, 
                days, currentDay, currentDayLabel,
                primaryColor, primaryColorInput, appBgColor, updateTheme,
                // è²¨å¹£èˆ‡åŒ¯ç‡
                baseCurrency, exchangeRate, baseCurrencySymbol, getCurrencySymbol, fetchExchangeRate, convertToBaseCurrency,
                // å¤©æ°£
                weatherLocation, weather, fetchWeather,
                // èˆªç­
                flightInfo,
                // è¨˜å¸³åŠŸèƒ½ç›¸é—œ
                expenses, expenseFilter, filteredExpenses, totalExpense,
                showAccountingModal, newExpense, addExpense,
                // ç·¨è¼¯åŠŸèƒ½ç›¸é—œ
                showEditModal, editingItem, openEditModal, saveEdit, deleteAndCloseEditModal,
                // æ¸…å–®
                todoList, shoppingList, openModal, deleteItem,
            }
        }
    }).mount('#app')
</script>
